{% extends 'downloader/base.html' %}

{% block content %}
<div class="container">
    <h2>Download Videos from YouTube, Facebook, and Twitter</h2>
    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}
    <form id="formatForm">
        {% csrf_token %}
        <div class="form-group">
            <label for="url">Video URL:</label>
            <input type="url" id="url" name="url" required placeholder="https://www.youtube.com/watch?v=...">
        </div>

        <button type="button" id="getFormatsBtn" placeholder="Quality">Next</button>
    </form>

    <div id="formatsContainer" style="display: none;">
        <h3>Select Format:</h3>
        <select id="formatSelect" style="width: 100%; padding: 10px; margin: 10px 0;">
            <option value="">Choose a format...</option>
        </select>
        <button id="downloadBtn" style="display: none;">Download Selected Format</button>
    </div>

    <div id="progressContainer" style="display: none;">
        <h3>Downloading...</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="progressText">0%</p>
    </div>
</div>

<script>
document.getElementById('url').addEventListener('input', function() {
    const errorDiv = document.querySelector('.error');
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
    // Hide formats when URL changes
    document.getElementById('formatsContainer').style.display = 'none';
    document.getElementById('downloadBtn').style.display = 'none';
});

document.getElementById('getFormatsBtn').addEventListener('click', function() {
    const url = document.getElementById('url').value.trim();
    if (!url) {
        alert('Please enter a URL first');
        return;
    }

    console.log('Getting formats for URL:', url);
    this.textContent = 'Loading formats...';
    this.disabled = true;

    fetch('', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            action: 'get_formats',
            url: url
        })
    })
    .then(response => {
        console.log('Formats response status:', response.status);
        return response.json();
    })
    .then(result => {
        console.log('Formats result:', result);
        if (result.error) {
            alert(result.error);
        } else {
            displayFormats(result.formats);
        }
    })
    .catch(error => {
        console.error('Error getting formats:', error);
        alert('Error getting formats: ' + error);
    })
    .finally(() => {
        this.textContent = 'Next';
        this.disabled = false;
    });
});

function displayFormats(formats) {
    const select = document.getElementById('formatSelect');
    select.innerHTML = '<option value="">Choose a format...</option>';

    formats.forEach(format => {
        const option = document.createElement('option');
        option.value = format.format_id;
        option.textContent = `${format.label} (${format.filesize_str})`;
        select.appendChild(option);
    });

    document.getElementById('formatsContainer').style.display = 'block';
    document.getElementById('downloadBtn').style.display = 'block';
}

document.getElementById('downloadBtn').addEventListener('click', function() {
    const url = document.getElementById('url').value.trim();
    const formatId = document.getElementById('formatSelect').value;

    console.log('Starting download with URL:', url, 'Format:', formatId);

    if (!formatId) {
        alert('Please select a format');
        return;
    }

    // Start download
    fetch('', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            action: 'download',
            url: url,
            format_id: formatId
        })
    })
    .then(response => {
        console.log('Download response status:', response.status);
        return response.json();
    })
    .then(result => {
        console.log('Download result:', result);
        if (result.error) {
            alert(result.error);
        } else {
            pollProgress(result.progress_id);
        }
    })
    .catch(error => {
        console.error('Error starting download:', error);
        alert('Error starting download: ' + error);
    });
});

function pollProgress(progressId) {
    document.getElementById('formatForm').style.display = 'none';
    document.getElementById('formatsContainer').style.display = 'none';
    document.getElementById('progressContainer').style.display = 'block';

    const interval = setInterval(() => {
        fetch(`/progress/${progressId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'downloading') {
                document.getElementById('progressFill').style.width = data.percent + '%';
                document.getElementById('progressText').textContent = `${data.percent}% - ${data.speed || 'N/A'} - ETA: ${data.eta || 'N/A'}`;
            } else if (data.status === 'finished' || data.status === 'completed') {
                clearInterval(interval);
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressText').textContent = 'Download completed! Starting download...';
                setTimeout(() => {
                    window.location.href = `/download/${progressId}/`;
                }, 1000);
            } else if (data.status === 'error') {
                clearInterval(interval);
                alert('Download failed: ' + data.error);
                location.reload();
            }
        })
        .catch(error => {
            clearInterval(interval);
            alert('Error checking progress: ' + error);
            location.reload();
        });
    }, 1000);
}
</script>
{% endblock %}